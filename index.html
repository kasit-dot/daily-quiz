<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Quiz Game</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>

    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai');
      
        * {
            box-sizing: border-box;
            font-family: 'Noto Sans Thai', sans-serif;
        }
      
        .time_line {
            height: 5px;
            width: 0;
            background-color: #ff9900;
            transition: width 0.5s linear;
        }

        .question-image {
            max-width: 100%;
            max-height: 200px;
            margin-bottom: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            background: linear-gradient(0deg, rgba(252, 233, 233, 1) 0%, rgba(224, 244, 241, 1) 26%, rgba(255, 255, 255, 1) 71%);
            flex-direction: column;
        }
      
        .list {
            background-color: #ffffff;
            padding: 1.8em 1.2em;
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
            border-radius: 0.6em;
        }

        footer {
            margin-top: 30px;
            background-color: #000;
            width: 100%;
            padding: 2px;
            position: fixed;
            bottom: 0;
        }

        footer p,
        footer a {
            text-decoration: none;
            margin: 0;
        }

        footer .fa {
            color: #fff740;
        }
    </style>

</head>
<body onload="initializeLiff()">

    <center class="mb-4">
        <img src="https://via.placeholder.com/200x100?text=Daily+Quiz" class="mt-4" style="width:200px; height:auto; padding-bottom: 10px;">
        <h2> Daily Quiz</h2>
        <h5 class="text-center text-danger">สื่อ และนวัตกรรมครูสิทธิชาติ สิทธิ</h5>
    </center>

    <div class="container list py-5">
        <div class="card ">
            <div class="card-header bg-primary text-white text-center">
                <h5 class="card-title mb-4 mt-4">คำชี้แจงในการทำแบบทดสอบ</h5>
            </div>
            <div class="card-body text-dark">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">1. มีเวลา <span id="timeValueDisplay">60</span> วินาทีในการทำแต่ละข้อ</li>
                    <li class="list-group-item">2. เมื่อตอบแล้วไม่สามารถเปลี่ยนคำตอบได้</li>
                    <li class="list-group-item">3. เมื่อทำเสร็จแล้วจะไม่สามารถแก้ไขได้อีก</li>
                    <li class="list-group-item">4. ต้องทำข้อสอบให้ครบทุกข้อ</li>
                    <li class="list-group-item">5. เมื่อตอบถูกจะได้คะแนนข้อละ 1 คะแนน</li>
                </ul>
                <div class="container my-3">
                    <label for="username" class="form-label"><h5><b>Line Username :</b></h5></label>
                    <input type="text" id="username" class="form-control" placeholder="กำลังโหลดชื่อ..." readonly required>
                </div>
            </div>
            <div class="card-footer text-end">
                <center><button class="btn btn-lg btn-primary mt-3 mb-3 restart">เริ่มทำแบบทดสอบ</button></center>
            </div>
        </div>
    </div>

    <div class="container list py-5 quiz_box" style="display:none;">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">แบบทดสอบ</h5>
                <div class="timer text-white px-3 py-2 rounded">
                    <span class="time_left_txb">เหลือเวลา</span>
                    <span class="timer_sec fw-bold" id="timerValue">60</span> วินาที
                </div>
            </div>
            <div class="progress" style="height: 5px;">
                <div class="time_line"></div>
            </div>
            <div class="card-body text-dark">
                <img id="question-image" class="question-image" style="display:none;">
                <div class="que_text mb-3"></div>
                <div class="option_list"></div>
            </div>
            <div class="card-footer d-flex justify-content-between">
                <div class="total_que mt-3 "></div>
                <button class="btn btn-primary next_btn" style="display:none;">ข้อถัดไป</button>
            </div>
        </div>
    </div>

    <div class="container list py-5 result_box" style="display:none;">
        <div class=" text-center">
            <div class="card-body">
                <div class="icon mb-3 mt-3">
                    <i class="fas fa-crown fa-3x text-primary"></i>
                </div>
                <h5 class="complete_text">คุณทำข้อสอบครบทุกข้อแล้ว!</h5>
                <div class="score_text my-3 mt-3 mb-3"></div>
                <div class="d-flex justify-content-center mb-3">
                    <button class="btn btn-primary share_score me-2">แชร์คะแนน</button>
                </div>
            </div>
        </div>
    </div>


<script>

    // --- ส่วนตั้งค่า (เปลี่ยนข้อมูลของคุณที่นี่) ---
    const liffId = 'AAAAAAAAAA';  // ใส่ LINE LIFF ID ของคุณ
    const webAppUrl = 'BBBBBBBBBB'; // ใส่ลิงก์ Google Web App สำหรับบันทึกคะแนน
    const fetchUrl = 'https://opensheet.elk.sh/CCCCCCCCCCC/Question'; // ใส่ลิงก์ดึงข้อมูลคำถาม
    const TIME_LIMIT = 60;  // เวลาต่อข้อ (วินาที)
    const Question_LIMIT = 5;   // จำนวนข้อที่ต้องการสุ่มขึ้นมาทำ
    // ----------------------------------------

    let questions = [];
    let userName = "";
    let lineUID = '';
    let que_count = 0;
    let userScore = 0;
    let counter;
    let counterLine;
    let answered = false;

    document.getElementById("timeValueDisplay").textContent = TIME_LIMIT;
    document.getElementById("timerValue").textContent = TIME_LIMIT;

    function initializeLiff() {
        liff.init({
            liffId: liffId 
        }).then(() => {
            if (liff.isLoggedIn()) {
                liff.getProfile().then(profile => {
                    lineUID = profile.userId;
                    userName = profile.displayName; 
                    document.getElementById('username').value = userName; 
                    loadQuestions();
                    checkDailySubmission(); // ตรวจสอบการล็อกวันละครั้ง
                }).catch(err => console.error(err));
            } else {
                liff.login();
            }
        }).catch(err => console.error(err));
    }

    function loadQuestions() {
        $.LoadingOverlay("show", { text: "กำลังโหลดคำถาม..." });

        fetch(fetchUrl) 
            .then(response => response.json())
            .then(data => {
                let allQuestions = data.map((item, index) => ({
                    numb: index + 1,
                    question: item["โจทย์"],
                    image: item["Image"], 
                    options: [item["ตัวเลือก 1"], item["ตัวเลือก 2"], item["ตัวเลือก 3"], item["ตัวเลือก 4"]],
                    answer: item["เฉลย"]
                }));

                allQuestions = shuffleArray(allQuestions);
                questions = allQuestions.slice(0, Question_LIMIT);
                $.LoadingOverlay("hide");
            })
            .catch(error => {
                console.error('Error:', error);
                $.LoadingOverlay("hide");
            });
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    document.querySelectorAll('.restart').forEach(button => {
        button.addEventListener('click', function() {
            if (document.getElementById('username').value.trim() === "") {
                Swal.fire('กรุณารอข้อมูลจาก LINE สักครู่...');
                return;
            }
            document.querySelector('.result_box').style.display = 'none';
            document.querySelector('.quiz_box').style.display = 'block'; 
            document.querySelector('.container').style.display = 'none';  
            startQuiz();
        });
    });

    function startQuiz() {
        que_count = 0;
        userScore = 0;
        showQuestions(que_count);
        queCounter(que_count + 1);
        startTimer(TIME_LIMIT);  
        startTimerLine(0);
    }

    function showQuestions(index){
        answered = false;
        const que_text = document.querySelector(".que_text");
        const questionImage = document.getElementById("question-image");

        que_text.innerHTML = `<span>${questions[index].question}</span>`;
        
        if (questions[index].image) {
            questionImage.src = questions[index].image;
            questionImage.style.display = "block";
        } else {
            questionImage.style.display = "none";
        }

        const option_list = document.querySelector(".option_list");
        option_list.innerHTML = ''; 

        questions[index].options.forEach(option => {
            const optionBtn = document.createElement("button");
            optionBtn.classList.add("btn", "btn-outline-primary", "d-block", "w-100", "mb-2");
            optionBtn.textContent = option;
            option_list.appendChild(optionBtn);

            optionBtn.addEventListener('click', function() {
                if (!answered) {
                    optionSelected(optionBtn, option);
                }
            });
        });
        document.querySelector('.next_btn').style.display = 'none';
    }

    function optionSelected(answerBtn, userAnswer){
        clearInterval(counter);
        clearInterval(counterLine);
        answered = true;
        let correctAnswer = questions[que_count].answer;

        if(userAnswer === correctAnswer){
            userScore++;
            answerBtn.classList.add("bg-success", "text-white");
        } else {
            answerBtn.classList.add("bg-danger", "text-white");
            // แสดงข้อที่ถูกให้ดู
            document.querySelectorAll(".btn-outline-primary").forEach(opt => {
                if(opt.textContent === correctAnswer) opt.classList.add("bg-success", "text-white");
            });
        }
        document.querySelector('.next_btn').style.display = 'block';
    }

    document.querySelector('.next_btn').addEventListener('click', function() {
        if (que_count < questions.length - 1) {
            que_count++;
            showQuestions(que_count);
            queCounter(que_count + 1);
            startTimer(TIME_LIMIT);
            startTimerLine(0);
        } else {
            showResult();
        }
    });

    function showResult(){
        document.querySelector('.quiz_box').style.display = "none";
        document.querySelector('.result_box').style.display = "block";

        const scoreText = document.querySelector(".score_text");
        scoreText.innerHTML = `<h4>คุณทำได้ ${userScore}/${questions.length} คะแนน</h4>`;

        saveQuizResults(userName, userScore, questions.length);

        document.querySelector('.share_score').addEventListener('click', function() {
            shareScore(userName, userScore, questions.length);
        });
    }

    function saveQuizResults(name, score, total) {
        $.LoadingOverlay("show", { text: "กำลังบันทึกข้อมูล..." });

        const payload = { name: name, score: score, total: total, lineUID: lineUID };

        fetch(webAppUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            $.LoadingOverlay("hide");
            
            // --- ปรับปรุง: ใช้เวลาไทยในการบันทึกการล็อก ---
            const today = new Date().toLocaleDateString('en-CA'); 
            localStorage.setItem('lastSubmission', today);
            
            Swal.fire({
                icon: 'success',
                title: 'บันทึกสำเร็จ',
                text: 'ระบบได้บันทึกคะแนนของคุณแล้ว'
            });
        }).catch(error => {
            console.error('Error:', error);
            $.LoadingOverlay("hide");
        });
    }

    function startTimer(time){
        counter = setInterval(() => {
            document.querySelector(".timer_sec").textContent = time < 10 ? "0" + time : time;
            time--;
            if (time < 0) {
                clearInterval(counter);
                if (!answered) markAsIncorrect();
            }
        }, 1000);
    }

    function markAsIncorrect() {
        answered = true;
        document.querySelectorAll(".btn-outline-primary").forEach(option => {
            if (option.textContent === questions[que_count].answer) {
                option.classList.add("bg-success", "text-white");
            }
        });
        document.querySelector('.next_btn').style.display = 'block';
    }

    function startTimerLine(time){
        const quizBoxWidth = document.querySelector('.quiz_box').clientWidth;
        counterLine = setInterval(() => {
            time += quizBoxWidth / (TIME_LIMIT * 1000 / 29);
            document.querySelector(".time_line").style.width = `${time}px`;
            if (time >= quizBoxWidth) clearInterval(counterLine);
        }, 29);
    }

    function queCounter(index){
        document.querySelector(".total_que").innerHTML = `<span>ข้อที่ ${index} / ${questions.length}</span>`;
    }

    function shareScore(name, score, total) {
        const flexMessage = {
            "type": "flex",
            "altText": "ผลคะแนน Daily Quiz",
            "contents": {
                "type": "bubble",
                "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        { "type": "text", "text": "ผลการทำแบบทดสอบ", "weight": "bold", "size": "xl" },
                        { "type": "text", "text": `ชื่อ: ${name}`, "margin": "md" },
                        { "type": "text", "text": `คะแนนที่ได้: ${score}/${total} คะแนน`, "size": "lg", "color": "#1DB446", "weight": "bold" }
                    ]
                }
            }
        };

        liff.shareTargetPicker([flexMessage])
            .then(() => {
                Swal.fire('แชร์คะแนนสำเร็จ!', '', 'success');
            })
            .catch(err => console.error(err));
    }

    // --- ฟังก์ชันตรวจการเข้าใช้งาน (ปรับปรุงเวลาไทย) ---
    function checkDailySubmission() {
        const lastSubmission = localStorage.getItem('lastSubmission');
        const today = new Date().toLocaleDateString('en-CA'); // ดึงวันที่ YYYY-MM-DD ตามเวลาไทย
        
        if (lastSubmission === today) {
            Swal.fire({
                icon: 'warning',
                title: 'คุณได้ส่งแบบทดสอบแล้ววันนี้',
                text: 'โปรดกลับมาอีกครั้งในวันพรุ่งนี้หลังเที่ยงคืนเพื่อทำใหม่ครับ',
                confirmButtonText: 'รับทราบ'
            });
            document.querySelector('.restart').disabled = true; 
        } else {
            document.querySelector('.restart').disabled = false;
        }
    }
  
</script>

<footer class="text-center text-lg-start bg-light text-muted" style="position: static; width: 100%;">
    <div class="text-center p-4" style="background-color: rgba(0, 0, 0, 0.05);">
        © 2026 Daily Quiz | พัฒนาโดยครูสิทธิชาติ สิทธิ
    </div>
</footer>

</body>
</html>
