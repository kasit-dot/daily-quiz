<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsyQ Daily Quiz Game</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>

    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai');
      
        * {
            box-sizing: border-box;
            font-family: 'Noto Sans Thai', sans-serif;
        }
      
        .time_line {
            height: 5px;
            width: 0;
            background-color: #ff9900;
            transition: width 0.5s linear;
        }

        .question-image {
            max-width: 100%;
            max-height: 200px;
            margin-bottom: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            background: linear-gradient(0deg, rgba(252, 233, 233, 1) 0%, rgba(224, 244, 241, 1) 26%, rgba(255, 255, 255, 1) 71%);
            flex-direction: column;
        }
      
        .list {
            background-color: #ffffff;
            padding: 1.8em 1.2em;
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
            border-radius: 0.6em;
            width: 90%;
            max-width: 500px;
            margin-top: 20px;
        }

        footer {
            margin-top: 30px;
            background-color: #000;
            width: 100%;
            padding: 15px;
            position: static;
            bottom: 0;
            color: white;
            text-align: center;
        }
    </style>

</head>
<body onload="initializeLiff()">

    <center class="mb-4">
        <img src="https://lh3.googleusercontent.com/d/1x6Obg8pQTwyOCOJgUeedP69z_zp37OW6" class="mt-4" style="width:120px; border-radius: 50%;">
        <h2 class="mt-3"> PsyQ : จิตเวช 5 ข้อ...รอให้คุณตอบ!</h2>
        <h5 class="text-center text-danger">ระบบทบทวนความรู้การพยาบาลสุขภาพจิตและจิตเวช</h5>
    </center>

    <div class="container list" id="info-box">
        <div class="card border-0">
            <div class="card-header bg-primary text-white text-center rounded">
                <h5 class="card-title mb-0 py-2">คำชี้แจงการทำแบบทดสอบรายวัน PsyQ</h5>
            </div>
            <div class="card-body text-dark px-0">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item border-0">1. มีเวลา <span id="timeValueDisplay">60</span> วินาทีในการทำแต่ละข้อ</li>
                    <li class="list-group-item border-0">2. เมื่อตอบแล้วไม่สามารถเปลี่ยนคำตอบได้</li>
                    <li class="list-group-item border-0">3. เมื่อทำเสร็จแล้วจะไม่สามารถแก้ไขได้อีก</li>
                    <li class="list-group-item border-0">4. ต้องทำข้อสอบให้ครบทุกข้อในแต่ละครั้ง</li>
                    <li class="list-group-item border-0">5. เมื่อตอบถูกจะได้คะแนนข้อละ 1 คะแนน</li>
                </ul>
                <div class="mt-4 px-3">
                    <label for="username" class="form-label fw-bold">Line Username :</label>
                    <input type="text" id="username" class="form-control" placeholder="กำลังโหลดชื่อจาก LINE..." readonly required>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 text-center">
                <button class="btn btn-lg btn-primary w-100 restart">เริ่มทำแบบทดสอบ</button>
            </div>
        </div>
    </div>

    <div class="container list py-5 quiz_box" style="display:none;">
        <div class="card border-0">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center rounded-top">
                <h5 class="card-title mb-0" id="que-count-text">แบบทดสอบ</h5>
                <div class="timer text-white px-3 py-2 rounded bg-danger">
                    <span class="timer_sec fw-bold" id="timerValue">60</span> วินาที
                </div>
            </div>
            <div class="progress" style="height: 5px;">
                <div class="time_line"></div>
            </div>
            <div class="card-body text-dark">
                <img id="question-image" class="question-image" style="display:none;">
                <div class="que_text h5 mb-4"></div>
                <div class="option_list d-grid gap-2"></div>
            </div>
            <div class="card-footer bg-transparent border-0 d-flex justify-content-between align-items-center">
                <div class="total_que"></div>
                <button class="btn btn-success next_btn" style="display:none;">ข้อถัดไป <i class="fas fa-chevron-right ms-1"></i></button>
            </div>
        </div>
    </div>

    <div class="container list py-5 result_box" style="display:none;">
        <div class="text-center">
            <div class="icon mb-3 mt-3">
                <i class="fas fa-crown fa-4x text-warning"></i>
            </div>
            <h3 class="complete_text">คุณทำข้อสอบครบแล้ว!</h3>
            <div class="score_text my-4 h4 text-primary"></div>
            <div class="d-grid gap-2 mb-3">
                <button class="btn btn-primary btn-lg share_score"><i class="fab fa-line me-2"></i>แชร์คะแนนเข้ากลุ่ม</button>
            </div>
        </div>
    </div>

<script>
    // --- ตั้งค่าระบบ (อ้างอิงข้อมูลจริงของอาจารย์) ---
    const liffId = '2009142140-tN6Av2XW';  //
    const webAppUrl = 'https://script.google.com/macros/s/AKfycbyeRSH_GGoU0NhlT1bJFNNv9-DxwWBxgdSSzmPvuVnmfDCJIf5h_RMCrNxkSiuR4vY/exec'; //
    const fetchUrl = 'https://opensheet.elk.sh/1NNPn11tCZZS1LbUQSem1ZS732E5x49PUyejvB6DjEog/Question'; //
    const TIME_LIMIT = 60;  // เวลาต่อข้อ
    const QUESTION_LIMIT = 5; // จำนวนข้อที่สุ่มมาทำ

    let questions = [];
    let userName = "";
    let lineUID = '';
    let que_count = 0;
    let userScore = 0;
    let userAnswers = []; // เก็บ {id: รหัสข้อ, result: 1/0}
    let counter, counterLine, answered = false;

    document.getElementById("timeValueDisplay").textContent = TIME_LIMIT;
    document.getElementById("timerValue").textContent = TIME_LIMIT;

    function initializeLiff() {
        liff.init({ liffId: liffId }).then(() => {
            if (liff.isLoggedIn()) {
                liff.getProfile().then(profile => {
                    lineUID = profile.userId;
                    userName = profile.displayName;
                    document.getElementById('username').value = userName;
                    checkDailySubmission(); // ตรวจสอบการทำซ้ำ
                    loadQuestions(); // โหลดข้อสอบ
                }).catch(err => console.error(err));
            } else {
                liff.login();
            }
        }).catch(err => console.error(err));
    }

    function loadQuestions() {
        $.LoadingOverlay("show", { text: "กำลังเตรียมข้อสอบ..." });
        fetch(fetchUrl)
            .then(response => response.json())
            .then(data => {
                // ดึง ID จากคอลัมน์ A และข้อมูลอื่นๆ
                let allQuestions = data.map((item, index) => ({
                    id: item["ID"] || (index + 1), // ใช้ ID ประจำข้อเพื่อวิเคราะห์รายข้อ
                    question: item["โจทย์"],
                    image: item["Image"],
                    options: [item["ตัวเลือก 1"], item["ตัวเลือก 2"], item["ตัวเลือก 3"], item["ตัวเลือก 4"]],
                    answer: item["เฉลย"]
                }));

                // สุ่มเลือกข้อสอบ 5 ข้อจากทั้งหมด
                questions = allQuestions.sort(() => 0.5 - Math.random()).slice(0, QUESTION_LIMIT);
                $.LoadingOverlay("hide");
            });
    }

    $('.restart').click(function() {
        if($('#username').val() === "") return;
        $('#info-box').hide();
        $('.quiz_box').show();
        startQuiz();
    });

    function startQuiz() {
        que_count = 0;
        userScore = 0;
        userAnswers = [];
        showQuestion(que_count);
    }

    function showQuestion(index) {
        answered = false;
        $('.next_btn').hide();
        $('.que_text').text(questions[index].question);
        $('#que-count-text').text(`ข้อที่ ${index + 1} / ${questions.length}`);
        
        if (questions[index].image) {
            $('#question-image').attr('src', questions[index].image).show();
        } else {
            $('#question-image').hide();
        }

        $('.option_list').empty();
        questions[index].options.forEach(option => {
            $(`<button class="btn btn-outline-primary py-3 text-start fw-bold">${option}</button>`)
                .click(function() { if(!answered) selectOption(this, option); })
                .appendTo('.option_list');
        });
        startTimer(TIME_LIMIT);
        startTimerLine(0);
    }

    function selectOption(btn, val) {
        answered = true;
        clearInterval(counter);
        clearInterval(counterLine);
        
        let correct = questions[que_count].answer;
        let isCorrect = (val === correct ? 1 : 0);
        
        // บันทึก ID คู่กับผลคะแนนเพื่อไปวิเคราะห์รายข้อใน Sheet
        userAnswers.push({ id: questions[que_count].id, result: isCorrect });

        if (isCorrect) {
            userScore++;
            $(btn).addClass('bg-success text-white');
        } else {
            $(btn).addClass('bg-danger text-white');
            $('.option_list button').each(function() {
                if($(this).text() === correct) $(this).addClass('bg-success text-white');
            });
        }
        $('.next_btn').show();
    }

    $('.next_btn').click(function() {
        que_count++;
        if (que_count < questions.length) {
            showQuestion(que_count);
        } else {
            showResult();
        }
    });

    function showResult() {
        $('.quiz_box').hide();
        $('.result_box').show();
        $('.score_text').text(`คุณทำได้ ${userScore} / ${questions.length} คะแนน`);
        saveData(); // บันทึกข้อมูล
    }

    function saveData() {
        $.LoadingOverlay("show", { text: "กำลังบันทึกและวิเคราะห์ผล..." });
        fetch(webAppUrl, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
                lineUID: lineUID,
                name: userName,
                score: userScore,
                total: questions.length,
                answers: userAnswers // ส่งข้อมูลรายข้อ {id, result}
            })
        }).then(() => {
            $.LoadingOverlay("hide");
            // บันทึกวันที่เพื่อล็อกวันละ 1 ครั้ง (ใช้เวลาไทย)
            localStorage.setItem('lastSub', new Date().toLocaleDateString('en-CA'));
            Swal.fire('สำเร็จ!', 'บันทึกคะแนนและวิเคราะห์รายข้อเรียบร้อย', 'success');
        });
    }

    function startTimer(time) {
        $('#timerValue').text(time);
        counter = setInterval(() => {
            time--;
            $('#timerValue').text(time < 10 ? "0" + time : time);
            if(time <= 0) { 
                clearInterval(counter); 
                if(!answered) {
                    userAnswers.push({ id: questions[que_count].id, result: 0 });
                    $('.next_btn').show();
                }
            }
        }, 1000);
    }

    function startTimerLine(time) {
        const quizBoxWidth = document.querySelector('.quiz_box').clientWidth;
        counterLine = setInterval(() => {
            time += quizBoxWidth / (TIME_LIMIT * 1000 / 29);
            document.querySelector(".time_line").style.width = `${time}px`;
            if (time >= quizBoxWidth) clearInterval(counterLine);
        }, 29);
    }

    function checkDailySubmission() {
        const today = new Date().toLocaleDateString('en-CA');
        if (localStorage.getItem('lastSub') === today) {
            Swal.fire({
                icon: 'warning',
                title: 'คุณทำไปแล้วในวันนี้',
                text: 'โปรดกลับมาใหม่ในวันพรุ่งนี้หลังเที่ยงคืนนะครับ',
                confirmButtonText: 'ตกลง'
            });
            $('.restart').prop('disabled', true);
        }
    }

    $('.share_score').click(function() {
        liff.shareTargetPicker([{
            "type": "flex",
            "altText": "PsyQ Quiz Score",
            "contents": {
                "type": "bubble",
                "body": {
                    "layout": "vertical",
                    "contents": [
                        { "type": "text", "text": "ผลสอบรายวัน PsyQ", "weight": "bold", "size": "xl" },
                        { "type": "text", "text": `คุณ ${userName}`, "margin": "md" },
                        { "type": "text", "text": `ทำได้ ${userScore}/${questions.length} คะแนน`, "size": "xxl", "color": "#1DB446", "weight": "bold" }
                    ]
                }
            }
        }]);
    });
</script>

<footer>
    © 2026 Copyright | พัฒนาโดย อ.ประกาศิต พูลวงษ์
</footer>

</body>
</html>
